<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Order Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 p-6">

  <h1 class="text-3xl font-bold mb-6">Order Details</h1>

  <div class="bg-white p-6 rounded shadow">
    <p><strong>Order ID:</strong>
      <%= order.orderId %>
    </p>
    <p><strong>Status:</strong>
      <%= order.status %>
    </p>
    <p><strong>Ordered At:</strong>
      <%= new Date(order.orderedAt).toLocaleDateString() %>
    </p>
    <p><strong>Delivered At:</strong>
      <%= order.deliveredAt ? new Date(order.deliveredAt).toLocaleDateString() : '-' %>
    </p>
    <p><strong>Total Amount:</strong> ₹<%= order.totalAmount %>
    </p>

    <!-- Entire Order Actions -->
    <div class="mt-4 flex gap-4">
      <% if(order.status !=='Delivered' && order.status !=='Cancelled' ) { %>
        <form action="/order/cancel/<%= order._id %>" method="POST">
          <button type="button" onclick="openReasonModal('/order/cancel/<%= order._id %>', 'Cancel Entire Order')"
            class="px-4 py-2 bg-red-600 text-white rounded">
            Cancel Entire Order
          </button>

        </form>
        <% } %>
    </div>

    <table class="min-w-full mt-6 border">
      <thead class="bg-gray-100">
        <tr>
          <th class="p-2 border">Product</th>
          <th class="p-2 border">Qty</th>
          <th class="p-2 border">Price</th>
          <th class="p-2 border">Status</th>
          <th class="p-2 border">Action</th>
        </tr>
      </thead>
      <tbody>
        <% order.items.forEach(item=> { %>
          <tr class="border-b">
            <td class="p-2 border flex items-center gap-2">
              <img src="<%= item.image %>" class="w-12 h-12 object-cover rounded">
              <%= item.name %>
            </td>
            <td class="p-2 border">
              <%= item.qty %>
            </td>
            <td class="p-2 border">₹<%= item.price %>
            </td>
            <td class="p-2 border">
              <%= item.status || order.status %>
            </td>
            <td class="p-2 border flex gap-2">
              <% if(item.status !=='Delivered' && order.status !=='Cancelled' ) { %>
                <form action="/order/cancel-item/<%= order._id %>/<%= item._id %>" method="POST">
                 <% if(item.status !== "Cancelled"){ %>
                   <button 
                    type="button"
                    onclick="openReasonModal('/order/cancel-item/<%= order._id %>/<%= item._id %>', 'Cancel Product')"
                    class="px-2 py-1 bg-red-500 text-white rounded text-xs">
                    Cancel
                  </button>
                  <% } %>
                </form>
                <% } %>
                  <% if(item.status==='Delivered' && order.status !=='Returned' ) { %>
                    <form action="/order/return-item/<%= order._id %>/<%= item._id %>" method="POST">
                      <button class="px-2 py-1 bg-yellow-500 text-white rounded text-xs">Return</button>
                    </form>
                    <% } %>
            </td>
          </tr>
          <% }) %>
      </tbody>
    </table>
  </div>

  <!-- Reason Modal -->
  <div id="reasonModal" class="fixed inset-0 bg-black bg-opacity-40 hidden justify-center items-center">
    <div class="bg-white p-6 rounded w-96">
      <h2 id="modalTitle" class="text-xl font-bold mb-4"></h2>

      <form id="reasonForm" method="POST">
        <textarea name="reason" required class="w-full p-2 border rounded" placeholder="Enter reason..."></textarea>

        <div class="mt-4 flex justify-end gap-2">
          <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-400 text-white rounded">Close</button>
          <button class="px-4 py-2 bg-blue-600 text-white rounded">Submit</button>
        </div>
      </form>
    </div>
  </div>


</body>
<script>

  function openReasonModal(actionUrl, title) {
    document.getElementById("reasonForm").action = actionUrl;
    document.getElementById("modalTitle").innerText = title;
    document.getElementById("reasonModal").classList.remove("hidden");
  }

  function closeModal() {
    document.getElementById("reasonModal").classList.add("hidden");
  }


</script>

</html>