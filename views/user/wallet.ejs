<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Wallet | Mambraville</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>

  <body class="bg-gray-50">
    ```
    <!-- Header (same as profile) -->
    <header class="bg-white shadow-sm">
      <%- include("../../views/partials/user/header") %>
    </header>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
      <h1 class="text-3xl font-bold text-gray-900 mb-6">My Wallet</h1>

      <div class="flex flex-col md:flex-row gap-6">
        <!-- Sidebar (EXACT same as profile) -->
        <div class="w-full md:w-1/3 lg:w-1/4">
          <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex flex-col items-center mb-6">
              <div class="text-center">
                <p class="text-gray-600 mb-1">Hello,</p>
                <h2 class="text-xl font-semibold"><%= user.fullname %></h2>
              </div>
            </div>

            <div class="border-t border-gray-200 pt-4">
              <ul class="space-y-4">
                <li>
                  <a
                    href="/user-Profile"
                    class="flex items-center text-gray-700 hover:text-indigo-600"
                  >
                    <i class="fas fa-user mr-3 w-5 text-gray-600"></i>
                    <span>Profile Information</span>
                  </a>
                </li>
                <li>
                  <a
                    href="/order-summary"
                    class="flex items-center text-gray-700 hover:text-indigo-600"
                  >
                    <i class="fas fa-shopping-bag mr-3 w-5 text-gray-600"></i>
                    <span>My Orders</span>
                  </a>
                </li>
                <li>
                  <a
                    href="/addressmanagement"
                    class="flex items-center text-gray-700 hover:text-indigo-600"
                  >
                    <i class="fas fa-home mr-3 w-5 text-gray-600"></i>
                    <span>Manage Addresses</span>
                  </a>
                </li>
                <li>
                  <a
                    href="/wallet"
                    class="flex items-center text-indigo-600 font-medium"
                  >
                    <i class="fas fa-wallet mr-3 w-5 text-gray-600"></i>
                    <span>My Wallet</span>
                  </a>
                </li>
                <li>
                  <a
                    href="/wishlist"
                    class="flex items-center text-gray-700 hover:text-indigo-600"
                  >
                    <i class="fas fa-heart mr-3 w-5 text-gray-600"></i>
                    <span>My Wishlist</span>
                  </a>
                </li>
                <li>
                  <a
                    href="/change-password"
                    class="flex items-center text-gray-700 hover:text-indigo-600"
                  >
                    <i class="fas fa-key mr-3 w-5 text-gray-600"></i>
                    <span>Change Password</span>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Wallet Main Content -->
        <div class="w-full md:w-2/3 lg:w-3/4">
          <!-- Wallet Balance Card -->
          <div
            class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-lg shadow p-6 text-white mb-6"
          >
            <p class="text-sm opacity-90">Available Balance</p>
            <h2 class="text-3xl font-bold mt-2">
              ₹ <%= wallet.balance.toFixed(2) %>
            </h2>
          </div>

          <!-- Wallet Actions -->
          <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4">Wallet Actions</h3>
            <div class="flex flex-wrap gap-4">
              <button
                id="openAddMoney"
                class="px-5 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700"
              >
                <i class="fas fa-plus mr-2"></i> Add Money
              </button>

              
            </div>
          </div>

         
          <!-- Wallet Transactions -->
<div class="bg-white rounded-lg shadow p-6">
  <h3 class="text-xl font-semibold mb-4">Recent Transactions</h3>

  <% if (transactions.length === 0) { %>
    <p class="text-gray-500 py-4">No wallet transactions yet.</p>
  <% } else { %>
    <div class="space-y-4 divide-y divide-gray-100">
      <% transactions.forEach(txn => { %>
        <div class="flex justify-between items-center py-3 first:pt-0 last:pb-0">
          <div>
            <p class="font-medium text-gray-900"><%= txn.description %></p>
            <p class="text-sm text-gray-500 mt-1">
              <%= txn.createdAt.toLocaleString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              }) %>
            </p>
          </div>
          <div class="text-right">
            <p class="font-semibold text-lg <%= txn.type === 'credit' ? 'text-green-600' : 'text-red-600' %>">
              <%= txn.type === 'credit' ? '+' : '-' %>₹<%= txn.amount.toFixed(2) %>
            </p>
            <p class="text-xs text-gray-400 capitalize mt-1"><%= txn.type %></p>
          </div>
        </div>
      <% }) %>
    </div>

    <!-- Pagination Controls -->
    <% if (totalPages > 1) { %>
      <div class="mt-8 flex flex-col sm:flex-row justify-between items-center gap-4 border-t pt-6">
        <div class="text-sm text-gray-600">
          Showing <%= (page - 1) * limit + 1 %>–<%= Math.min(page * limit, totalTransactions) %>
          of <%= totalTransactions %> transactions
        </div>

        <nav class="flex items-center gap-1">
          <% if (hasPrev) { %>
            <a href="/wallet?page=<%= page - 1 %>&limit=<%= limit %>"
               class="px-4 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition">
              ← Previous
            </a>
          <% } %>

          <% for (let i = 1; i <= totalPages; i++) { %>
            <a href="/wallet?page=<%= i %>&limit=<%= limit %>"
               class="px-4 py-2 rounded font-medium
                      <%= page === i
                        ? 'bg-indigo-600 text-white'
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200' %>">
              <%= i %>
            </a>
          <% } %>

          <% if (hasNext) { %>
            <a href="/wallet?page=<%= page + 1 %>&limit=<%= limit %>"
               class="px-4 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition">
              Next →
            </a>
          <% } %>
        </nav>
      </div>
    <% } %>
  <% } %>
</div>
        </div>
      </div>
    </div>
    ```
    <!-- Add Money Modal -->
    <div
      id="addMoneyModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
    >
      <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
        <h2 class="text-xl font-semibold mb-4">Add Money to Wallet</h2>

        <!-- Amount Input -->
        <label class="block text-sm text-gray-600 mb-1">Enter Amount</label>
        <input
          type="number"
          id="walletAmount"
          class="w-full border rounded px-3 py-2 mb-4"
          placeholder="Enter amount (₹)"
        />

        <!-- Quick Amount Buttons -->
        <div class="flex gap-3 mb-4">
          <button
            onclick="setAmount(500)"
            class="px-4 py-2 bg-gray-100 rounded hover:bg-gray-200"
          >
            ₹500
          </button>
          <button
            onclick="setAmount(1000)"
            class="px-4 py-2 bg-gray-100 rounded hover:bg-gray-200"
          >
            ₹1000
          </button>
          <button
            onclick="setAmount(2000)"
            class="px-4 py-2 bg-gray-100 rounded hover:bg-gray-200"
          >
            ₹2000
          </button>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end gap-3">
          <button
            onclick="closeAddMoney()"
            class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
          >
            Cancel
          </button>
          <button
            onclick="payWallet()"
            class="px-5 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700"
          >
            Pay Now
          </button>
        </div>
      </div>
    </div>
     <%-include("../../views/partials/user/footer")-%>
  </body>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
      const modal = document.getElementById("addMoneyModal");
      const amountInput = document.getElementById("walletAmount");

      document.getElementById("openAddMoney").addEventListener("click", () => {
        modal.classList.remove("hidden");
        amountInput.focus();
      });

      function closeAddMoney() {
        modal.classList.add("hidden");
        amountInput.value = "";
      }

      function setAmount(amount) {
        amountInput.value = amount;
      }

      async function payWallet() {
        const amount = Number(amountInput.value.trim());

        if (!amount || amount < 1) {
          Swal.fire({
            icon: 'warning',
            title: 'Invalid Amount',
            text: 'Please enter a valid amount (minimum ₹1)',
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000
          });
          return;
        }

        try {
          const response = await fetch("/wallet/create-order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ amount }),
          });

          const data = await response.json();

          if (!data.success) {
            Swal.fire({
              icon: 'error',
              title: 'Payment Error',
              text: data.message || "Unable to create payment order. Please try again.",
              toast: true,
              position: 'top-end',
              timer: 4000
            });
            return;
          }

          const options = {
            key: data.key,
            amount: data.order.amount,
            currency: "INR",
            name: "Mambraville Wallet",
            description: "Add money to wallet",
            order_id: data.order.id,
            handler: async function (response) {
              try {
                const verifyRes = await fetch("/wallet/verify-payment", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    razorpay_order_id: response.razorpay_order_id,
                    razorpay_payment_id: response.razorpay_payment_id,
                    razorpay_signature: response.razorpay_signature,
                    amount: amount,
                  }),
                });

                const verifyData = await verifyRes.json();

                if (verifyData.success) {
                  Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: '₹' + amount + ' added to your wallet successfully.',
                    toast: false,
                    timer: 2800,
                    showConfirmButton: false,
                    position: 'center'
                  }).then(() => {
                    window.location.reload();
                  });
                } else {
                  Swal.fire({
                    icon: 'error',
                    title: 'Verification Failed',
                    text: verifyData.message || "Payment verification failed. Please contact support.",
                    toast: true,
                    position: 'top-end',
                    timer: 5000
                  });
                }
              } catch (err) {
                Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: 'Something went wrong during verification.',
                  toast: true,
                  position: 'top-end'
                });
              }
            },
            theme: {
              color: "#4F46E5",
            },
          };

          const rzp = new Razorpay(options);
          rzp.open();
          closeAddMoney();

        } catch (err) {
          Swal.fire({
            icon: 'error',
            title: 'Network Error',
            text: 'Failed to connect. Please check your internet connection.',
            toast: true,
            position: 'top-end',
            timer: 4000
          });
        }
      }
    </script>
</html>
