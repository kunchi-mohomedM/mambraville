<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Product - Mambraville Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropper/4.1.0/cropper.css" integrity="sha512-iAcZ4OrGhQ7KDqtM+LMc+iuv63aJ9O7hPyWBzCXsrZYuhJ6jhdeh40+hf9o4QmZVu8QrH/cWy/JTmoKNOL4Urw==" crossorigin="anonymous" referrerpolicy="no-referrer" /> -->
<!-- <script src="https://cdnjs.cloudfla\/re.com/ajax/libs/cropper/4.1.0/cropper.min.js" integrity="sha512-E+gDQcIvNXE60SjCS38ysf1mGh4ObBpKcUOp0oEaHQHQAdaN2p7GelOpgEdpTuCLoIJyLkNXiqFZbyD9Ak/Ygw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Main Content -->
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-gradient-to-r from-black to-purple-900 text-white p-4 w-full flex justify-between items-center shadow-md">
            <h1 class="text-2xl font-bold">Add Product</h1>
            <div class="flex items-center">
                <span class="mr-4">Admin User</span>
                <img src="https://via.placeholder.com/40" alt="Admin" class="rounded-full h-8 w-8">
            </div>
        </header>

        <!-- Add Product Form -->
        <div class="flex-1 p-4 md:p-6 overflow-y-auto">
            <form class="bg-white p-6 rounded-lg shadow-md w-full max-w-5xl mx-auto" id="productForm" method="post" action="/admin/addproduct" enctype="multipart/form-data">
                <!-- Product Name -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2" for="product-name">Product Name</label>
                    <input type="text" name="productName" id="product-name" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600 bg-gray-50" placeholder="Enter product name"  >
                    <p id="error-productName" class="text-red-500 text-sm mt-1"></p>
                </div>

                <!-- Description -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2" for="description">Description</label>
                    <textarea id="description" name="description" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600 bg-gray-50" rows="4" placeholder="Enter product description"  ></textarea>
                    <p id="error-description" class="text-red-500 text-sm mt-1"></p>
                </div>

                <!-- Price and Discount -->
                <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2" for="price">Price ($)</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500">$</span>
                            </div>
                            <input type="number" name="price" id="price" class="w-full p-3 pl-8 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600 bg-gray-50" placeholder="0.00" step="0.01"  >
                            <p id="error-price" class="text-red-500 text-sm mt-1"></p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2" for="discount">Discount (%)</label>
                        <div class="relative">
                            <input type="number" name="discount" id="discount" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600 bg-gray-50" placeholder="0" min="0" max="100">
                            <p id="error-discount" class="text-red-500 text-sm mt-1"></p>
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500">%</span>
                            </div>
                        </div>
                    </div>
                </div>
<!-- Category Dropdown -->
<div>
    <label class="block text-gray-700 font-semibold mb-2" for="category">Category</label>
    <select id="category" name="category" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600 bg-gray-50"  >
        <p id="error-category" class="text-red-500 text-sm mt-1"></p>
        <option value="" disabled selected>Select a category</option>
        <% categories.forEach(category => { %>
            <option value="<%= category._id %>"><%= category.categoryname %></option>
        <% }); %>
    </select>
</div>

<!-- Brand Dropdown -->
<div>
    <label class="block text-gray-700 font-semibold mb-2" for="brand">Brand</label>
    <select id="brand" name="brand" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600 bg-gray-50"  >
        <p id="error-brand" class="text-red-500 text-sm mt-1"></p>
        <option value="" disabled selected>Select a brand</option>
        <% brands.forEach(brand => { %>
            <option value="<%= brand._id %>"><%= brand.brandname %></option> <!-- Fixed here -->
        <% }); %>
    </select>
</div>


                <!-- Stock -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2" for="stock">Stock Quantity</label>
                    <input type="number" name="quantity" id="stock" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600 bg-gray-50" placeholder="Enter stock quantity" min="0"  >
                    <p id="error-quantity" class="text-red-500 text-sm mt-1"></p>
                </div>

                <!-- Product Images -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">Product Images (4  )</label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                            <label for="image1" class="cursor-pointer flex flex-col items-center justify-center h-32">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                <span class="text-sm text-gray-600">Image 1 (Main)</span>
                                <span class="text-xs text-gray-500 mt-1">Click to upload</span>
                                <input type="file" id="image1" name="productImages" class="hidden" accept="image/*"  >
                            </label>
                        </div>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                            <label for="image2" class="cursor-pointer flex flex-col items-center justify-center h-32">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                <span class="text-sm text-gray-600">Image 2</span>
                                <span class="text-xs text-gray-500 mt-1">Click to upload</span>
                                <input type="file" id="image2" name="productImages" class="hidden" accept="image/*"  >
                            </label>
                        </div>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                            <label for="image3" class="cursor-pointer flex flex-col items-center justify-center h-32">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                <span class="text-sm text-gray-600">Image 3</span>
                                <span class="text-xs text-gray-500 mt-1">Click to upload</span>
                                <input type="file" id="image3" name="productImages" class="hidden" accept="image/*"  >
                            </label>
                        </div>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                            <label for="image4" class="cursor-pointer flex flex-col items-center justify-center h-32">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                <span class="text-sm text-gray-600">Image 4</span>
                                <span class="text-xs text-gray-500 mt-1">Click to upload</span>
                                <input type="file" id="image4" name="productImages" class="hidden" accept="image/*"  >
                            </label>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">Upload exactly 4 images (max 5MB each). Supported formats: JPG, PNG, WebP</p>
                    <p id="error-productName" class="text-red-500 text-sm mt-1"></p>
                </div>

                <!-- Submit Buttons -->
                <div class="flex flex-col sm:flex-row justify-end gap-3 mt-8">
                    <button type="button" class="bg-gray-300 text-gray-800 py-3 px-6 rounded-lg hover:bg-gray-400 transition duration-300">Cancel</button>
                    <button type="submit" class="bg-purple-600 text-white py-3 px-6 rounded-lg hover:bg-purple-700 transition duration-300 flex items-center justify-center">
                        <i class="fas fa-plus-circle mr-2"></i> Add Product
                    </button>
                </div>
            </form>
        </div>

        <!-- Footer -->
        <footer class="bg-white p-4 text-center text-gray-500 border-t">
            <p>&copy; 2025 Mambraville Admin. All rights reserved.</p>
        </footer>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function() {

    const form = document.getElementById('productForm');
    const imageInputs = document.querySelectorAll('input[type="file"]');
    const cropperInstances = {};

  // ==== IMAGE PREVIEW + CROPPER ====
    imageInputs.forEach((input, index) => {
    input.addEventListener('change', function() {
      const file = this.files[0];
      if (!file) return;

      const allowedFormats = ["image/jpeg", "image/png", "image/jpg"];
      const maxSize = 5 * 1024 * 1024;

      if (!allowedFormats.includes(file.type)) {
        showError('error-images', "Invalid file type! Please upload PNG or JPG.");
        this.value = "";
        return;
      }

      if (file.size > maxSize) {
        showError('error-images', "File size exceeds 5MB! Please upload a smaller file.");
        this.value = "";
        return;
      }

      clearError('error-images');

      let label = this.parentElement;
      let preview = label.querySelector('img');
      if (!preview) {
        preview = document.createElement('img');
        preview.style.maxWidth = '100%';
        label.insertBefore(preview, label.firstChild);
      }
      preview.src = URL.createObjectURL(file);

      if (cropperInstances[index]) cropperInstances[index].destroy();

      cropperInstances[index] = new Cropper(preview, {
        aspectRatio: 1,
        viewMode: 1,
        autoCropArea: 1
      });
    });
  });

  // ==== FORM VALIDATION ====
  form.addEventListener('submit', function(e) {
    e.preventDefault();

    // Clear all previous errors
    document.querySelectorAll('p[id^="error-"]').forEach(p => p.textContent = "");

    let isValid = true;

    const productName = document.getElementById('product-name').value.trim();
    const description = document.getElementById('description').value.trim();
    const price = parseFloat(document.getElementById('price').value);
    const discount = parseFloat(document.getElementById('discount').value);
    const quantity = parseFloat(document.getElementById('stock').value);
    const category = document.getElementById('category').value;
    const brand = document.getElementById('brand').value;

    // ==== VALIDATION CHECKS ====
    if (!productName) {
      showError('error-productName', "Product name is required.");
      isValid = false;
    }

    if (!description) {
      showError('error-description', "Description is required.");
      isValid = false;
    }

    if (!category) {
      showError('error-category', "Select a category.");
      isValid = false;
    }

    if (!brand) {
      showError('error-brand', "Select a brand.");
      isValid = false;
    }

    if (isNaN(price) || price <= 0) {
      showError('error-price', "Price must be greater than 0.");
      isValid = false;
    }

    if (isNaN(discount) || discount < 0 || discount > 100) {
      showError('error-discount', "Discount must be between 0 and 100.");
      isValid = false;
    }

    if (isNaN(quantity) || quantity < 0) {
      showError('error-quantity', "Quantity cannot be negative.");
      isValid = false;
    }

    const uploadedImages = Array.from(imageInputs).filter(i => i.files.length > 0).length;
    if (uploadedImages !== 4) {
      showError('error-images', "Please upload exactly 4 images.");
      isValid = false;
    }

    if (!isValid) return false;

    // ==== CROPPER PROCESS ====
    const promises = [];

    imageInputs.forEach((input, index) => {
      const cropper = cropperInstances[index];
      if (cropper) {
        promises.push(new Promise((resolve) => {
          cropper.getCroppedCanvas().toBlob(blob => {
            const dt = new DataTransfer();
            dt.items.add(new File([blob], input.files[0].name, { type: blob.type }));
            input.files = dt.files;
            resolve();
          }, 'image/jpeg', 0.9);
        }));
      }
    });

    Promise.all(promises).then(() => {
      form.submit();
    });
  });

  // ==== HELPER FUNCTIONS ====
  function showError(id, message) {
    const el = document.getElementById(id);
    if (el) el.textContent = message;
  }

  function clearError(id) {
    const el = document.getElementById(id);
    if (el) el.textContent = "";
  }

});


    </script>
</body>
</html>