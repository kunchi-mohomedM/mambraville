<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Product - Mambraville Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-gradient-to-r from-black to-purple-900 text-white p-4 w-full flex justify-between items-center shadow-md">
        <h1 class="text-2xl font-bold">Edit Product</h1>
        <div class="flex items-center space-x-4">
            <span>Admin User</span>
            <img src="https://via.placeholder.com/40" alt="Admin profile" class="rounded-full h-8 w-8">
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-6 overflow-y-auto">
        <form class="bg-white p-6 rounded-lg shadow-md w-full max-w-5xl mx-auto" 
              id="productForm" 
              method="POST" 
              action="/admin/editproduct/<%= product._id %>" 
              enctype="multipart/form-data">

            <input type="hidden" name="productId" value="<%= product._id %>">

            <!-- Product Name -->
            <div class="mb-6">
                <label class="block text-gray-700 font-semibold mb-2" for="product-name">Product Name</label>
                <input type="text" 
                       name="productName" 
                       id="product-name" 
                       value="<%= product.productName %>" 
                       class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600 bg-gray-50"
                       placeholder="Enter product name" 
                       required>
            </div>

            <!-- Description -->
            <div class="mb-6">
                <label class="block text-gray-700 font-semibold mb-2" for="description">Description</label>
                <textarea name="description" 
                          id="description" 
                          rows="4" 
                          class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600 bg-gray-50"
                          placeholder="Enter product description"
                          required><%= product.description %></textarea>
            </div>

            <!-- Price & Discount -->
            <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2" for="price">Price ($)</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-500">$</span>
                        </div>
                        <input type="number" 
                               name="price" 
                               id="price" 
                               value="<%= product.price %>" 
                               step="0.01" 
                               min="0" 
                               class="w-full p-3 pl-8 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600 bg-gray-50"
                               placeholder="0.00" 
                               required>
                    </div>
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2" for="discount">Discount (%)</label>
                    <div class="relative">
                        <input type="number" 
                               name="discount" 
                               id="discount" 
                               value="<%= product.discount %>" 
                               min="0" 
                               max="100" 
                               class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600 bg-gray-50"
                               placeholder="0">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <span class="text-gray-500">%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Category -->
            <div class="mb-6">
                <label class="block text-gray-700 font-semibold mb-2" for="category">Category</label>
                <select name="category" id="category"
                        class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600 bg-gray-50"
                        required>
                    <option value="" disabled>Select a category</option>
                    <% categories.forEach(category => { %>
                        <option value="<%= category._id %>"
                                <%= product.category && product.category.toString() === category._id.toString() ? 'selected' : '' %>>
                            <%= category.categoryname %>
                        </option>
                    <% }); %>
                </select>
            </div>

            <!-- Brand -->
            <div class="mb-6">
                <label class="block text-gray-700 font-semibold mb-2" for="brand">Brand</label>
                <select name="brand" id="brand"
                        class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600 bg-gray-50"
                        required>
                    <option value="" disabled>Select a brand</option>
                    <% brands.forEach(brand => { %>
                        <option value="<%= brand._id %>"
                                <%= product.brand && product.brand.toString() === brand._id.toString() ? 'selected' : '' %>>
                            <%= brand.brandname %>
                        </option>
                    <% }); %>
                </select>
            </div>

            <!-- Stock -->
            <div class="mb-6">
                <label class="block text-gray-700 font-semibold mb-2" for="stock">Stock Quantity</label>
                <input type="number" 
                       name="quantity" 
                       id="stock" 
                       value="<%= product.quantity %>" 
                       min="0" 
                       class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600 bg-gray-50"
                       placeholder="Enter stock quantity"
                       required>
            </div>

            <!-- Product Images -->
            <div class="mb-6">
                <label class="block text-gray-700 font-semibold mb-2">Product Images (exactly 4 required)</label>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                    <% for(let i = 0; i < 4; i++) { %>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center relative group"
                         id="preview-container-<%= i+1 %>">
                        <label for="image<%= i+1 %>" 
                               class="cursor-pointer flex flex-col items-center justify-center h-32"
                               id="label-<%= i+1 %>">
                            <% if (product.productImage && product.productImage[i]) { %>
                                <img src="<%= product.productImage[i].url %>" 
                                     alt="Product image <%= i+1 %>" 
                                     class="w-full h-32 object-contain rounded-lg">
                                <input type="hidden" 
                                       name="keepPublicIds" 
                                       value="<%= product.productImage[i].public_id %>">
                            <% } else { %>
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                <span class="text-sm text-gray-600">Image <%= i+1 %></span>
                                <span class="text-xs text-gray-500 mt-1">Click to upload</span>
                            <% } %>
                        </label>
                        <input type="file" 
                               id="image<%= i+1 %>" 
                               class="hidden image-input" 
                               data-index="<%= i %>" 
                               accept="image/jpeg,image/png,image/webp">
                    </div>
                    <% } %>
                </div>
                <p class="text-sm text-gray-500 mt-2">
                    Upload exactly 4 images (max 5MB each). Supported: JPG, PNG, WebP
                </p>
            </div>

            <!-- Submit Buttons -->
            <div class="flex flex-col sm:flex-row justify-end gap-4 mt-8">
                <a href="/admin/products"
                   class="bg-gray-300 text-gray-800 py-3 px-6 rounded-lg hover:bg-gray-400 transition text-center">
                    Cancel
                </a>
                <button type="submit"
                        class="bg-purple-600 text-white py-3 px-6 rounded-lg hover:bg-purple-700 transition flex items-center justify-center">
                    <i class="fas fa-save mr-2"></i> Update Product
                </button>
            </div>
        </form>
    </main>

    <!-- Footer -->
    <footer class="bg-white p-4 text-center text-gray-500 border-t mt-auto">
        <p>© 2025 Mambraville Admin. All rights reserved.</p>
    </footer>

    <!-- Crop Modal -->
    <div id="cropModal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-3xl w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Crop Image</h3>
                <button type="button" onclick="closeCropModal()" class="text-gray-600 hover:text-gray-800">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div class="mb-6 max-h-[60vh] overflow-auto">
                <img id="cropImage" class="max-w-full" alt="Image to crop">
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeCropModal()"
                        class="bg-gray-300 text-gray-800 py-2 px-5 rounded hover:bg-gray-400">
                    Cancel
                </button>
                <button type="button" onclick="applyCrop()"
                        class="bg-purple-600 text-white py-2 px-5 rounded hover:bg-purple-700">
                    Apply Crop
                </button>
            </div>
        </div>
    </div>

    <script>
        let cropper = null;
        let currentImageIndex = -1;
        const selectedFiles = {};           // index → File
        const existingPublicIds = new Array(4).fill(null);

        // Initialize existing public ids
        document.querySelectorAll('input[name="keepPublicIds"]').forEach(input => {
            const container = input.closest('[id^="preview-container-"]');
            const index = parseInt(container.id.match(/\d+$/)[0]) - 1;
            existingPublicIds[index] = input.value;
        });

        // File input handlers
        document.querySelectorAll('.image-input').forEach(input => {
            input.addEventListener('change', e => {
                const file = e.target.files[0];
                if (!file) return;

                const index = parseInt(input.dataset.index);

                if (!['image/jpeg','image/jpg','image/png','image/webp'].includes(file.type)) {
                    Swal.fire('Invalid format', 'Only JPG, PNG, WebP allowed', 'warning');
                    return;
                }
                if (file.size > 5 * 1024 * 1024) {
                    Swal.fire('File too large', 'Image must be under 5MB', 'warning');
                    return;
                }

                openCropModal(file, index);
            });
        });

        // Form submission
        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const keptCount = existingPublicIds.filter(Boolean).length;
            const newCount  = Object.keys(selectedFiles).length;
            
            if (keptCount + newCount !== 4) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Incomplete Images',
                    text: `Exactly 4 images required. You have ${keptCount + newCount}.`,
                });
                return;
            }

            const formData = new FormData(this);

            // Remove old keepPublicIds inputs (we'll rebuild them)
            formData.delete('keepPublicIds');

            // Add new cropped files + indices
            Object.entries(selectedFiles).forEach(([index, file]) => {
                formData.append('productImages', file);
                formData.append('imageIndices', index);
            });

            // Re-add kept images with their indices
            existingPublicIds.forEach((publicId, index) => {
                if (publicId && !selectedFiles[index]) {   // only if not replaced
                    formData.append('keepPublicIds', publicId);
                    formData.append('keepIndices', index);
                }
            });

            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Updating...';

            try {
                const res = await fetch(this.action, { method: 'POST', body: formData });
                const data = await res.json();

                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: 'Product updated successfully',
                        confirmButtonColor: '#7c3aed'
                    }).then(() => {
                        window.location.href = '/admin/products';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message || 'Failed to update product'
                    });
                }
            } catch (err) {
                console.error(err);
                Swal.fire('Error', 'Network error. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Update Product';
            }
        });

        function openCropModal(file, index) {
            currentImageIndex = index;
            const modal = document.getElementById('cropModal');
            const img   = document.getElementById('cropImage');

            const reader = new FileReader();
            reader.onload = e => {
                img.src = e.target.result;
                modal.style.display = 'flex';

                if (cropper) cropper.destroy();
                cropper = new Cropper(img, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 0.95,
                    responsive: true,
                    restore: false
                });
            };
            reader.readAsDataURL(file);
        }

        function closeCropModal() {
            document.getElementById('cropModal').style.display = 'none';
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            currentImageIndex = -1;
        }

        function applyCrop() {
            if (!cropper || currentImageIndex < 0) return;

            cropper.getCroppedCanvas({
                width: 1000,
                height: 1000,
                imageSmoothingQuality: 'high'
            }).toBlob(blob => {
                const file = new File([blob], `image_${currentImageIndex}.jpg`, { type: 'image/jpeg' });
                selectedFiles[currentImageIndex] = file;

                // Update preview
                const container = document.getElementById(`preview-container-${currentImageIndex + 1}`);
                const label = container.querySelector('label');
                label.innerHTML = `<img src="${URL.createObjectURL(blob)}" class="w-full h-32 object-contain rounded-lg" alt="Preview">`;

                // Remove old keep input if exists
                const oldInput = container.querySelector('input[name="keepPublicIds"]');
                if (oldInput) oldInput.remove();

                // Mark as replaced
                existingPublicIds[currentImageIndex] = null;

                closeCropModal();
            }, 'image/jpeg', 0.92);
        }
    </script>
</body>
</html>